.:53 {
  log
  debug
  reload 2s
  erratic

  rewrite continue {
    ttl regex .* 30
  }

  cache 1
  
  # ec2 fix
  rewrite stop name regex (ip-\d{1,3}-\d{1,3}-\d{1,3}-\d{1,3})\.ec2\.internal {1}.ec2.internal
  rewrite stop name regex (.*)\.ec2\.internal {1}.invalid

  # service mesh
  template IN A cluster1 {
    answer "{{ .Name }} 30 IN CNAME elb1"
  }
  template IN A cluster2 {
    answer "{{ .Name }} 30 IN CNAME elb2"
  }

  template IN ANY global {
    answer "{{ .Name }} 60 IN CNAME cluster1"
    answer "{{ .Name }} 60 IN CNAME cluster2"
    fallthrough
  }

  # default actions
  forward . 1.1.1.1
}